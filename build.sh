#!/bin/bash
# è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬ - Mac/Linux

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "========================================================================"
echo "ğŸš€ Stir Email Checker - è‡ªåŠ¨æ„å»ºè„šæœ¬"
echo "========================================================================"

# æ£€æŸ¥ Node.js
if ! command -v node &> /dev/null; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Node.jsï¼Œè¯·å…ˆå®‰è£…"
    exit 1
fi

# æ£€æŸ¥ Python
if ! command -v python3 &> /dev/null; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Python3ï¼Œè¯·å…ˆå®‰è£…"
    exit 1
fi

# æ­¥éª¤ 1: æ„å»ºå‰ç«¯
echo ""
echo "ğŸ“¦ æ­¥éª¤ 1/4: æ„å»ºå‰ç«¯..."
echo "------------------------------------------------------------------------"
cd frontend

if [ ! -d "node_modules" ]; then
    echo "   å®‰è£…å‰ç«¯ä¾èµ–..."
    npm install
fi

echo "   æ„å»ºå‰ç«¯..."
npm run build

if [ ! -d "dist" ]; then
    echo "âŒ é”™è¯¯: å‰ç«¯æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ° dist ç›®å½•"
    exit 1
fi

echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
cd ..

# æ­¥éª¤ 2: å‡†å¤‡ Python ç¯å¢ƒ
echo ""
echo "ğŸ æ­¥éª¤ 2/4: å‡†å¤‡ Python ç¯å¢ƒ..."
echo "------------------------------------------------------------------------"

if [ ! -d "venv" ]; then
    echo "   åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ..."
    python3 -m venv venv
fi

echo "   æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ..."
source venv/bin/activate

echo "   æ£€æŸ¥ä¾èµ–..."
pip install -q pyinstaller

echo "âœ… Python ç¯å¢ƒå‡†å¤‡å®Œæˆ"

# æ­¥éª¤ 3: æ¸…ç†æ—§æ–‡ä»¶
echo ""
echo "ğŸ§¹ æ­¥éª¤ 3/4: æ¸…ç†æ—§æ„å»º..."
echo "------------------------------------------------------------------------"
rm -rf build dist __pycache__
echo "âœ… æ¸…ç†å®Œæˆ"

# æ­¥éª¤ 4: æ‰“åŒ…åº”ç”¨
echo ""
echo "ğŸ“¦ æ­¥éª¤ 4/4: æ‰“åŒ…åº”ç”¨..."
echo "------------------------------------------------------------------------"
pyinstaller build_exe.spec --clean --noconfirm

if [ ! -f "dist/StirEmailChecker" ]; then
    echo "âŒ é”™è¯¯: æ‰“åŒ…å¤±è´¥ï¼Œæœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
    exit 1
fi

echo "âœ… æ‰“åŒ…å®Œæˆ"

# æ˜¾ç¤ºç»“æœ
echo ""
echo "========================================================================"
echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
echo "========================================================================"
echo "ğŸ“ å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®: $(pwd)/dist/StirEmailChecker"
echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h dist/StirEmailChecker | cut -f1)"
echo ""
echo "ğŸš€ è¿è¡Œæµ‹è¯•:"
echo "   cd dist"
echo "   ./StirEmailChecker"
echo ""
echo "========================================================================"

